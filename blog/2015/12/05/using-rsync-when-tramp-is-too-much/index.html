<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Using Rsync when Tramp is too much - org-page</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Diego Berrocal">
    <meta name="description" content="Rsync stuff">
    <meta name="keywords" content="&lt;TODO: insert your keywords here&gt;">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Fira+Sans:400,700,400italic,700italic|Lora:400,700|Source+Code+Pro:400,700">
    <link rel="stylesheet" href="/media/css/normalize.css">
    <link rel="stylesheet" href="/media/css/dark.css" id="darkTheme">
    <link rel="stylesheet" href="/media/css/light.css" id="lightTheme">
    <link href="http://cestdiego.github.io/atom.xml" type="application/atom+xml" rel="alternate" title="Diego Berrocal" />
    <script>
     var lightTheme = document.querySelector("#lightTheme");
     var darkTheme = document.querySelector("#darkTheme");

     var toggleTheme = function () {
         var isDefaultDisabled = lightTheme.disabled;
         darkTheme.disabled = isDefaultDisabled;
         lightTheme.disabled = !isDefaultDisabled;

         var switchLights = document.querySelector(".switch-lights");
         switchLights.textContent = "lights " + (isDefaultDisabled ? "off" : "on");

         return !isDefaultDisabled;
     };

     if (localStorage.darkTheme === "1") {
         toggleTheme();
     }
    </script>
    <link rel="stylesheet" href="/media/css/main.css">
    <noscript>
        <style>
         .toggle-colors{
             display: none;
         }
        </style>
    </noscript>
  </head>

  <body>
    <div id="wrapper">
    <nav class="site-nav">
      <ul class="links">
        <li><a href="/">org-page</a></li>
         <li><a href="/about/">about</a></li>
        <li><a href="/blog/">Blog</a></li>
        <li><a href="/tags/">Tags</a></li>
        <li><a href="/atom.xml">atom</a></li>
        <li><button class="switch-lights">lights off</button></li>
      </ul>
    </nav>

    <article class="post">
      <header>
          <h1 class="post-title">Using Rsync when Tramp is too much</h1>
      </header>
      <p>
So, during the <a href="http://sachachua.com/blog/2015/11/2015-11-18-emacs-hangout/">Nov 18th Emacs Hangout</a> I mentioned that I stopped using TRAMP a
while ago and instead started using rsync to do remote stuff.
</p>


<p>
It&rsquo;s time to share my setup. This are the things I used:
</p>

<div id="outline-container-org9da721a" class="outline-2">
<h2 id="org9da721a">Requirements:</h2>
<div class="outline-text-2" id="text-org9da721a">
<ul class="org-ul">
<li><a href="https://github.com/wasamasa/firestarter">Firestarter</a></li>
<li><a href="http://batsov.com/projectile/">Projectile</a></li>
</ul>
</div>
</div>

<div id="outline-container-org308d5bd" class="outline-2">
<h2 id="org308d5bd">Resources:</h2>
<div class="outline-text-2" id="text-org308d5bd">
<ul class="org-ul">
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-copy-files-with-rsync-over-ssh">ssh-options to not ask for confirmation of the server everytime</a></li>
<li><a href="http://www.gnu.org/software/emacs/manual/html_node/emacs/Directory-Variables.html">Directory local variables Documentation (.dir-locals.el)</a></li>
</ul>



<p>
In short, <code>directory local variables</code> are variables that are set for every file
that is opened that belongs to the target directory, in this case, our project
directory.
</p>

<p>
With the <code>Firestarter</code> package, we assign the <code>firestarter</code> variable to a
function and the package will execute it each time a file in our project is
saved. The only question left is &ldquo;What function should we use to sync our project
with our server?&rdquo;
</p>

<p>
We&rsquo;ll call rsync from within Emacs, we want it to obey the .gitignore rules as
well, and maybe also send the .git directory so that we have all the commits and
everything in the server (these options should all be customizable)
</p>

<p>
Create a <code>.dir-locals.el</code> file in the root of the project directory, then insert
the following things here (I&rsquo;m synchronizing my current folder with a test
folder in my server that has user nope and IP 40.756.140.43 (yes, 756 is not in
the IP range, this is on purpose so bots don&rsquo;t go pinging this IP), therefore
the whole path looks like <code>nope@40.756.140.43:test/</code>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">  ;; .dir-locals.el
  ((nil
    .
    ((firestarter . (let* ((rsync--obey-gitignore t)
                           (rsync--exclude-git nil)
                           (args `("-aP"
                                   "'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'"
                                   "--delete"
                                   ,(when (and rsync--obey-gitignore
                                               (file-exists-p ".gitignore"))
                                      "--filter=':- .gitignore'")
                                   ,(when rsync--exclude-git
                                      "--exclude='.git/'")
                                   ,(projectile-project-root)
                                   "nope@40.756.140.43:test/")))
                      (apply 'start-process "rsync" nil "rsync" args))))))
</pre>
</div>

<p>
<b><b>Update</b></b> Thank you @wasamasa for the suggestion on not using
<code>async-shell-command</code>
</p>

<p>
I hope this is useful to someone that has had issues with TRAMP before as well.
Rsync will manage to only copy stuff that is different. But I don&rsquo;t know how
good it is with binary data, but I know git is not good with it. Please comment
if this is an issue.
</p>
</div>
</div>

    </article>

<footer class="site-footer">
    <div class="back-to-top">
        <a href="#">back to top</a>
        <a id="show-comments"  onclick="loadDisqus()"> show comments</a>
    </div>
    <script src="/media/js/main.js"></script>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</footer>

    </div>
  </body>
</html>
